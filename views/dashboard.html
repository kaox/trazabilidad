<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Analítico</title>
    <script src="/auth.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fdfaf6; }
        h1, h2, h3, .font-display { font-family: 'Playfair Display', serif; }
    </style>
</head>
<body class="text-stone-800 antialiased">
    <nav class="bg-amber-900 text-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <div class="flex justify-center items-center flex-grow">
                    <a href="/app/fincas" class="px-4 py-2 rounded-md text-sm font-medium hover:bg-amber-800 transition">Fincas</a>
                    <a href="/app/trazabilidad" class="px-4 py-2 rounded-md text-sm font-medium bg-amber-800 transition">Trazabilidad</a>
                    <a href="/app/dashboard" class="px-4 py-2 rounded-md text-sm font-medium hover:bg-amber-800 transition">Dashboard</a>
                </div>
                <button onclick="logout()" class="px-4 py-2 rounded-md text-sm font-medium hover:bg-red-700 bg-red-600 transition">Cerrar Sesión</button>
            </div>
        </div>
    </nav>
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-10 mt-4">
            <h1 class="text-4xl md:text-5xl font-bold text-amber-900 mb-2">Dashboard Analítico</h1>
            <p class="text-stone-600">Visualiza los datos clave de tu proceso.</p>
        </header>
        <section class="mb-12">
            <h2 class="text-2xl font-display text-amber-900 border-b pb-2 mb-6">Inventario en Proceso</h2>
            <div id="inventory-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
        </section>
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="text-xl font-display text-amber-900 mb-4 text-center">Rendimiento Promedio por Etapa</h3><canvas id="rendimientoChart"></canvas></div>
            <div class="bg-white p-6 rounded-2xl shadow-lg"><h3 class="text-xl font-display text-amber-900 mb-4 text-center">Producción por Finca (kg Baba)</h3><canvas id="produccionChart"></canvas></div>
        </section>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const batches = await fetch('/api/batches/tree').then(res => res.json());
            const processMetrics = {
                fermentacion: { totalInput: 0, totalOutput: 0, count: 0 },
                secado:       { totalInput: 0, totalOutput: 0, count: 0 },
                tostado:      { totalInput: 0, totalOutput: 0, count: 0 },
                molienda:     { totalInput: 0, totalOutput: 0, count: 0 }
            };
            const produccionPorFinca = {};
            const inventario = {
                'Cosechado (p/ fermentar)': { total: 0, unit: 'kg Baba'},
                'Fermentado (p/ secar)':   { total: 0, unit: 'kg Húmedo'},
                'Seco (p/ tostar)':        { total: 0, unit: 'kg Seco'},
                'Tostado (p/ moler)':      { total: 0, unit: 'kg Tostado'}
            };

            batches.forEach(c => {
                const finca = c.finca || 'No especificada';
                produccionPorFinca[finca] = (produccionPorFinca[finca] || 0) + (parseFloat(c.pesoBaba) || 0);
                let babaAsignada = 0;
                (c.fermentaciones || []).forEach(f => {
                    babaAsignada += parseFloat(f.pesoBaba) || 0;
                    processMetrics.fermentacion.totalInput += parseFloat(f.pesoBaba) || 0;
                    processMetrics.fermentacion.totalOutput += parseFloat(f.pesoFermentadoHumedo) || 0;
                    processMetrics.fermentacion.count++;
                    let fermentadoAsignado = 0;
                    (f.secados || []).forEach(s => {
                        fermentadoAsignado += parseFloat(s.pesoFermentadoHumedo) || 0;
                        processMetrics.secado.totalInput += parseFloat(s.pesoFermentadoHumedo) || 0;
                        processMetrics.secado.totalOutput += parseFloat(s.pesoSeco) || 0;
                        processMetrics.secado.count++;
                        let secoAsignado = 0;
                        (s.tostados || []).forEach(t => {
                            secoAsignado += parseFloat(t.pesoSeco) || 0;
                            processMetrics.tostado.totalInput += parseFloat(t.pesoSeco) || 0;
                            processMetrics.tostado.totalOutput += parseFloat(t.pesoTostado) || 0;
                            processMetrics.tostado.count++;
                            let tostadoAsignado = 0;
                            (t.moliendas || []).forEach(m => {
                               tostadoAsignado += parseFloat(m.pesoTostado) || 0;
                               processMetrics.molienda.totalInput += parseFloat(m.pesoTostado) || 0;
                               processMetrics.molienda.totalOutput += parseFloat(m.pesoProductoFinal) || 0;
                               processMetrics.molienda.count++;
                            });
                            inventario['Tostado (p/ moler)'].total += (parseFloat(t.pesoTostado) || 0) - tostadoAsignado;
                        });
                        inventario['Seco (p/ tostar)'].total += (parseFloat(s.pesoSeco) || 0) - secoAsignado;
                    });
                    inventario['Fermentado (p/ secar)'].total += (parseFloat(f.pesoFermentadoHumedo) || 0) - fermentadoAsignado;
                });
                inventario['Cosechado (p/ fermentar)'].total += (parseFloat(c.pesoBaba) || 0) - babaAsignada;
            });

            document.getElementById('inventory-cards').innerHTML = Object.keys(inventario).map(key => `
                <div class="bg-white p-5 rounded-2xl shadow-lg text-center">
                    <p class="text-stone-500 text-sm">${key}</p>
                    <p class="text-3xl font-bold text-amber-900 mt-2">${inventario[key].total.toFixed(2)}</p>
                    <p class="text-stone-500 text-xs">${inventario[key].unit}</p>
                </div>`).join('');

            new Chart(document.getElementById('rendimientoChart'), {
                type: 'bar',
                data: {
                    labels: ['Fermentación', 'Secado', 'Tostado', 'Molienda'],
                    datasets: [{
                        label: 'Rendimiento (%)',
                        data: Object.values(processMetrics).map(m => m.totalInput > 0 ? (m.totalOutput / m.totalInput) * 100 : 0),
                        backgroundColor: 'rgba(120, 53, 15, 0.6)',
                        borderColor: 'rgba(120, 53, 15, 1)',
                        borderWidth: 1
                    }]
                },
                options: { scales: { y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } } }, plugins: { legend: { display: false } } }
            });
            new Chart(document.getElementById('produccionChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(produccionPorFinca),
                    datasets: [{
                        data: Object.values(produccionPorFinca),
                        backgroundColor: ['rgba(120,53,15,0.7)', 'rgba(180,83,9,0.7)', 'rgba(217,119,6,0.7)', 'rgba(245,158,11,0.7)', 'rgba(251,191,36,0.7)'],
                        hoverOffset: 4
                    }]
                }
            });
        } catch (error) {
            document.getElementById('inventory-cards').innerHTML = `<p class="text-red-500 col-span-full text-center">Error al cargar datos del dashboard.</p>`
        }
    });
    </script>
</body>
</html>

