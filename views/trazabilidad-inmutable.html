<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Certificaciones Inmutables - Ruru Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    <!-- Librerías para PDF (Reutilizadas de trazabilidad) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="/auth.js"></script>
    <style>
        .font-display { font-family: 'Playfair Display', serif; }
    </style>
</head>
<body class="bg-gray-50 text-stone-800">
    
    <div id="nav-placeholder"></div>

    <div class="container mx-auto px-6 py-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-amber-900 mb-2">Pasaportes Digitales Activos</h1>
            <p class="text-stone-600">Listado de lotes certificados con trazabilidad inmutable y sello blockchain.</p>
        </header>

        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-stone-100 text-stone-600">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider">Lote / Hash</th>
                            <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider">Proceso & Etapa</th>
                            <th class="px-6 py-4 text-center text-xs font-bold uppercase tracking-wider">Estadísticas</th>
                            <th class="px-6 py-4 text-right text-xs font-bold uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="immutable-table-body" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="4" class="px-6 py-12 text-center text-gray-500">
                                <i class="fas fa-circle-notch fa-spin text-2xl mb-3"></i><br>Cargando certificaciones...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Contenedor Oculto para Generación PDF (Reutilizado) -->
    <div id="pdf-report-container" class="fixed top-0 left-0 -z-50 w-[800px] bg-white p-8 hidden"></div>

    <script src="/js/nav-loader.js"></script>
    
    <!-- Script Específico de la Página -->
    <script>
        // Declaramos variables globales para los gráficos del PDF (simulando trazabilidad-app.js)
        let chartInstances = {}; 
        
        document.addEventListener('DOMContentLoaded', async () => {
            await loadImmutableBatches();
        });

        async function loadImmutableBatches() {
            const tbody = document.getElementById('immutable-table-body');
            try {
                const batches = await api('/api/batches/immutable');
                
                if (batches.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" class="px-6 py-12 text-center">
                                <div class="flex flex-col items-center justify-center text-stone-400">
                                    <i class="fas fa-certificate text-4xl mb-4 opacity-50"></i>
                                    <p class="text-lg font-medium">No tienes lotes certificados aún.</p>
                                    <p class="text-sm mt-1">Ve a Trazabilidad y finaliza un lote para generar su Pasaporte Digital.</p>
                                    <a href="/app/trazabilidad" class="mt-4 px-4 py-2 bg-amber-800 text-white rounded-lg text-sm hover:bg-amber-900 transition">Ir a Trazabilidad</a>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = batches.map(batch => {
                    const hashShort = batch.blockchain_hash ? batch.blockchain_hash.substring(0, 12) + '...' : 'Generando...';
                    const stars = renderStars(batch.avg_rating);
                    
                    // Detectar si tiene perfil sensorial para habilitar el botón de reporte
                    // Buscamos en la data guardada del lote
                    const hasQualityData = batch.data && (batch.data.tipoPerfil || batch.data.tipoRuedaSabor);

                    return `
                        <tr class="hover:bg-amber-50/50 transition-colors">
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-10 w-10 bg-green-100 rounded-full flex items-center justify-center text-green-700">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-bold text-gray-900">${batch.id}</div>
                                        <div class="text-xs font-mono text-gray-500 bg-gray-100 px-2 py-0.5 rounded inline-block mt-1 cursor-help" title="${batch.blockchain_hash}">
                                            <i class="fas fa-link mr-1"></i>${hashShort}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm font-medium text-gray-900">${batch.tipo_proceso}</div>
                                <div class="text-xs text-gray-500">
                                    Etapa final: <span class="font-semibold text-amber-700">${batch.ultima_etapa}</span>
                                </div>
                                <div class="text-xs text-gray-400 mt-1">
                                    ${new Date(batch.created_at).toLocaleDateString()}
                                </div>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <div class="flex flex-col gap-2">
                                    <div class="text-sm text-stone-600" title="Veces escaneado/visto">
                                        <i class="far fa-eye mr-1"></i> <strong>${batch.views}</strong> vistas
                                    </div>
                                    <div class="flex items-center justify-center gap-1 text-xs" title="${batch.total_reviews} reseñas">
                                        ${stars} <span class="text-stone-400">(${batch.total_reviews})</span>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-right text-sm font-medium space-x-2">
                                <a href="/${batch.id}" target="_blank" class="text-indigo-600 hover:text-indigo-900 bg-indigo-50 hover:bg-indigo-100 p-2 rounded-lg transition" title="Ver Página Pública">
                                    <i class="fas fa-external-link-alt"></i>
                                </a>
                                <button onclick="downloadQR('${batch.id}')" class="text-stone-600 hover:text-stone-900 bg-stone-100 hover:bg-stone-200 p-2 rounded-lg transition" title="Descargar QR">
                                    <i class="fas fa-qrcode"></i>
                                </button>
                                ${hasQualityData ? `
                                    <button onclick="generatePDF('${batch.id}')" class="text-red-600 hover:text-red-900 bg-red-50 hover:bg-red-100 p-2 rounded-lg transition" title="Descargar Reporte PDF">
                                        <i class="fas fa-file-pdf"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error(error);
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-red-500 py-4">Error cargando datos.</td></tr>`;
            }
        }

        function renderStars(rating) {
            const r = Math.round(rating);
            let html = '';
            for (let i = 1; i <= 5; i++) {
                html += `<i class="fas fa-star ${i <= r ? 'text-yellow-400' : 'text-gray-300'}"></i>`;
            }
            return html;
        }

        window.downloadQR = function(id) {
            const url = `${window.location.origin}/${id}`;
            const qr = qrcode(0, 'L');
            qr.addData(url);
            qr.make();
            const link = document.createElement('a');
            link.href = qr.createDataURL(4, 10); // Scale up for better quality
            link.download = `Pasaporte_QR_${id}.png`;
            link.click();
        };

        // --- Lógica de PDF (Copiada y adaptada para funcionar standalone aquí) ---
        // Nota: Para no duplicar código masivamente, idealmente esto debería estar en un script compartido.
        // Pero para mantener la simplicidad de "no build tools", lo incluimos aquí.
        window.generatePDF = async function(batchId) {
            const btn = document.querySelector(`button[onclick="generatePDF('${batchId}')"]`);
            if(btn) btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                // 1. Obtener datos completos de trazabilidad para este lote
                const history = await api(`/api/trazabilidad/${batchId}`);
                
                // Encontrar el nodo específico del lote (o usar el último de la cadena si es el mismo)
                // En este caso, history.stages tiene todo el array. El lote bloqueado puede ser el último.
                const stageData = history.stages.find(s => s.id === batchId);
                if (!stageData) throw new Error("Datos del lote no encontrados en la trazabilidad");

                // Datos de contexto (Finca, etc)
                const template = history.ownerInfo; // Usamos ownerInfo para la empresa
                const fincaData = history.fincaData || {};
                
                // Preparar datos para el template HTML
                const getVal = (data, key) => data && data[key] ? (data[key].value || data[key]) : '';
                
                // Buscar perfil sensorial
                let sensoryData = null;
                let flavorData = null;
                const perfilName = getVal(stageData.data, 'tipoPerfil');
                if (perfilName) {
                    // Tendríamos que buscar el perfil en history.perfilSensorialData si coincide
                    // Simplificación: usaremos history.perfilSensorialData si existe
                    sensoryData = history.perfilSensorialData;
                }
                if (history.ruedaSaborData) {
                    flavorData = history.ruedaSaborData;
                }

                // Renderizar HTML oculto
                const container = document.getElementById('pdf-report-container');
                container.classList.remove('hidden');
                
                // ... (Template HTML del PDF - Mismo que en trazabilidad-app.js) ...
                container.innerHTML = `
                    <div class="font-sans text-stone-800 bg-white p-8 border-4 border-amber-900/10 h-full">
                        <div class="flex justify-between items-center border-b-2 border-amber-800 pb-6 mb-8">
                            <div>
                                <h1 class="text-4xl font-display font-bold text-amber-900">Reporte de Calidad</h1>
                                <p class="text-stone-500 mt-1">Certificado de Análisis Sensorial</p>
                            </div>
                            <div class="text-right">
                                <h2 class="text-2xl font-bold text-stone-800">${template.empresa || 'Ruru Lab'}</h2>
                                <p class="text-xs text-stone-500">Hash: ${stageData.blockchain_hash || 'N/A'}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-8 mb-8">
                            <div class="bg-stone-50 p-6 rounded-xl">
                                <h3 class="font-bold text-xl text-amber-900 mb-4">Datos de Origen</h3>
                                <ul class="space-y-2 text-sm">
                                    <li><strong>Código Lote:</strong> ${batchId}</li>
                                    <li><strong>Finca:</strong> ${fincaData.nombre_finca || getVal(stageData.data, 'finca') || '-'}</li>
                                    <li><strong>Productor:</strong> ${fincaData.propietario || '-'}</li>
                                    <li><strong>Ubicación:</strong> ${fincaData.ciudad || '-'}, ${fincaData.pais || '-'}</li>
                                </ul>
                            </div>
                            <div class="bg-amber-50 p-6 rounded-xl text-center">
                                <h3 class="font-bold text-xl text-amber-900 mb-2">Puntuación</h3>
                                <span class="text-6xl font-bold text-amber-900">${parseFloat(getVal(stageData.data, 'puntuacion') || 0).toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-8">
                            <div>
                                <h4 class="font-bold text-center mb-4">Perfil Sensorial</h4>
                                <div class="relative aspect-square"><canvas id="pdf-radar-chart"></canvas></div>
                            </div>
                            <div>
                                <h4 class="font-bold text-center mb-4">Rueda de Sabor</h4>
                                <div class="relative aspect-square flex items-center justify-center">
                                    <canvas id="pdf-doughnut-chart" class="absolute inset-0"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Render Charts
                if (sensoryData) {
                    new Chart(document.getElementById('pdf-radar-chart'), {
                        type: 'radar',
                        data: {
                            labels: Object.keys(sensoryData),
                            datasets: [{ label: 'Perfil', data: Object.values(sensoryData), backgroundColor: 'rgba(146, 64, 14, 0.2)', borderColor: 'rgba(146, 64, 14, 1)', borderWidth: 2 }]
                        },
                        options: { scales: { r: { suggestedMin: 0, suggestedMax: 10, ticks: { display: false } } }, plugins: { legend: { display: false } }, animation: false }
                    });
                }
                
                // Esperar render
                await new Promise(r => setTimeout(r, 500));

                const canvas = await html2canvas(container, { scale: 2, useCORS: true });
                const imgData = canvas.toDataURL('image/jpeg', 0.8);
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`Certificado_${batchId}.pdf`);

            } catch (err) {
                console.error(err);
                alert("Error generando PDF: " + err.message);
            } finally {
                if(btn) btn.innerHTML = '<i class="fas fa-file-pdf"></i>';
                document.getElementById('pdf-report-container').classList.add('hidden');
            }
        };
    </script>
</body>
</html>