<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Actualizar Datos de Finca - Rurulab</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
    
    <!-- Google Maps -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAM37iJTRcIoSAxESlDzB2DxlNJWKasW5U&libraries=drawing,geometry,places&callback=initMap&v=weekly" defer></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <script src="/js/analytics-loader.js" defer></script>
    <style type="text/tailwindcss">
        body { font-family: 'Inter', sans-serif; background-color: #fdfaf6; /* Fondo Ruru Lab */ }
        h1, h2, h3, .font-display { font-family: 'Playfair Display', serif; }
        
        #map { height: 450px; width: 100%; border-radius: 0.75rem; border: 1px solid #d6d3d1; }
        
        /* Inputs estilizados Ruru Lab Style */
        .input-field { 
            @apply w-full p-4 bg-white border border-stone-300 rounded-xl text-stone-800 text-base shadow-sm focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition-all placeholder-stone-400; 
        }
        .input-readonly {
            @apply bg-stone-100 border-stone-200 text-stone-600 font-medium cursor-not-allowed select-none;
        }
        .label-field { 
            @apply block text-xs font-bold text-stone-500 mb-2 uppercase tracking-wider; 
        }
        .section-card {
            @apply bg-white p-6 rounded-2xl border border-stone-200 shadow-md mb-8;
        }
        .section-title {
            @apply text-xl font-display font-bold text-amber-900 border-b border-stone-100 pb-3 mb-6 flex items-center gap-3;
        }
        .step-badge {
            @apply w-8 h-8 rounded-full bg-amber-100 text-amber-800 text-sm flex items-center justify-center font-bold border border-amber-200;
        }
    </style>
</head>
<body class="text-stone-800 pb-12 antialiased">

    <div class="max-w-xl mx-auto min-h-screen flex flex-col shadow-2xl bg-white border-x border-stone-100">
        
        <!-- Header Ruru Lab -->
        <header class="bg-white/90 backdrop-blur-md sticky top-0 z-50 border-b border-stone-200 py-4 px-6">
            <div class="flex justify-between items-center">
                <a href="https://rurulab.com" target="_blank" class="flex items-center gap-2 group">
                    <i class="fa-solid fa-fingerprint text-2xl text-amber-900 group-hover:text-amber-700 transition"></i>
                    <div>
                        <h1 class="text-xl font-bold font-display text-amber-900 leading-none group-hover:text-amber-700 transition">Ruru Lab</h1>
                        <span class="text-[10px] font-bold text-stone-400 uppercase tracking-widest">Portal Productor</span>
                    </div>
                </a>
                <!-- Estado de conexión simulado -->
                <div class="flex items-center gap-1.5 bg-green-50 px-2 py-1 rounded-full border border-green-100">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <span class="text-[10px] font-bold text-green-700 uppercase">Seguro</span>
                </div>
            </div>
        </header>

        <main class="flex-grow p-4 md:p-8 bg-[#fdfaf6]">
            
            <div id="loading" class="text-center py-32">
                <div class="animate-spin rounded-full h-14 w-14 border-4 border-stone-200 border-t-amber-800 mx-auto mb-6"></div>
                <h3 class="text-lg font-bold text-stone-700 mb-1">Cargando Ficha</h3>
                <p class="text-stone-500 text-sm">Conectando con la base de datos...</p>
            </div>

            <form id="public-form" class="hidden animate-fade-in-up">
                
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-display font-bold text-stone-900">Actualizar Información</h2>
                    <p class="text-stone-500 text-sm mt-1">Completa los datos para el Pasaporte Digital de tu finca.</p>
                </div>

                <!-- SECCIÓN 1: DATOS GENERALES -->
                <div class="section-card">
                    <h3 class="section-title">
                        <span class="step-badge">1</span> Datos Generales
                    </h3>
                    
                    <div class="space-y-6">
                        <!-- Foto Productor -->
                        <div class="flex flex-col items-center justify-center p-6 bg-stone-50 rounded-2xl border-2 border-dashed border-stone-200 hover:bg-stone-100 transition cursor-pointer group" onclick="document.getElementById('productor-foto-input').click()">
                            <label class="label-field text-center w-full mb-3 cursor-pointer">Foto de Perfil</label>
                            <div class="relative">
                                <img id="productor-foto-preview" src="https://placehold.co/150x150/e7e5e4/78716c?text=Subir+Foto" class="w-32 h-32 rounded-full object-cover border-4 border-white shadow-lg group-hover:scale-105 transition duration-300">
                                <div class="absolute bottom-0 right-0 bg-amber-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-md border-2 border-white">
                                    <i class="fas fa-camera text-sm"></i>
                                </div>
                            </div>
                            <input type="file" id="productor-foto-input" class="hidden" accept="image/*">
                            <input type="hidden" name="foto_productor" id="foto_productor">
                            <p class="text-xs font-bold text-stone-400 mt-3 bg-white px-3 py-1 rounded-full shadow-sm">Toca para cambiar</p>
                        </div>

                        <div>
                            <label class="label-field">Nombre de la Finca <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <input type="text" name="nombre_finca" id="nombre_finca" class="input-field pl-10" placeholder="Ej. Finca La Esperanza" readonly>
                            </div>
                        </div>

                        <div>
                            <label class="label-field">Propietario / Productor <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <input type="text" name="propietario" id="propietario" class="input-field pl-10" required>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-5">
                            <div>
                                <label class="label-field">DNI / RUC</label>
                                <input type="tel" name="dni_ruc" id="dni_ruc" class="input-field">
                            </div>
                            <div>
                                <label class="label-field">Teléfono</label>
                                <input type="tel" name="telefono" id="telefono" class="input-field">
                            </div>
                        </div>

                        <div>
                            <label class="label-field">Nº Trabajadores</label>
                            <div class="relative">
                                <input type="number" name="numero_trabajadores" id="numero_trabajadores" class="input-field pl-10" placeholder="0">
                            </div>
                        </div>

                        <div>
                            <label class="label-field">Historia / Descripción</label>
                            <textarea name="historia" id="historia" rows="4" class="input-field" placeholder="Cuenta brevemente la historia de tu finca, tu familia y tu pasión por el cultivo..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN 2: UBICACIÓN DEL PREDIO (MAPA) -->
                <div class="section-card overflow-hidden">
                    <h3 class="section-title">
                        <span class="step-badge">2</span> Ubicación Satelital
                    </h3>
                    
                    <div class="mb-4">
                        <label class="label-field">Buscar Lugar</label>
                        <div class="flex gap-2 shadow-sm rounded-xl">
                            <div class="relative flex-grow">
                                <input type="text" id="map-search" class="input-field pl-10 rounded-r-none border-r-0 focus:ring-0" placeholder="Ej. Villa Rica, Oxapampa">
                            </div>
                            <button type="button" id="btn-search-map" class="bg-stone-800 hover:bg-stone-900 text-white px-5 rounded-r-xl font-bold transition">
                                Ir
                            </button>
                        </div>
                    </div>

                    <div class="relative rounded-2xl overflow-hidden border-4 border-white shadow-lg">
                        <div id="map"></div>
                        
                        <!-- Controles flotantes -->
                        <div class="absolute top-4 right-4 flex flex-col gap-2">
                            <button type="button" id="btn-locate" class="bg-white text-amber-700 w-12 h-12 rounded-xl shadow-lg flex items-center justify-center text-xl hover:bg-amber-50 transition active:scale-95 border border-stone-200" title="Mi Ubicación">
                                <i class="fas fa-crosshairs"></i>
                            </button>
                        </div>
                        
                        <div class="absolute bottom-4 left-4 right-4 bg-white/95 backdrop-blur-md px-4 py-3 rounded-xl shadow-lg border border-stone-200 text-xs font-medium text-stone-600 text-center">
                            <i class="fas fa-hand-pointer text-amber-600 mr-2 text-lg align-middle"></i>
                            Usa la herramienta de dibujo (polígono) en el mapa para marcar los límites de tu terreno.
                        </div>
                    </div>
                    <!-- Campo oculto para guardar coords -->
                    <input type="hidden" name="coordenadas" id="coordenadas">
                </div>

                <!-- SECCIÓN 3: DATOS DEL TERRENO (AUTOCOMPLETADO) -->
                <div class="section-card bg-gradient-to-br from-stone-50 to-white border-stone-200 relative overflow-hidden">
                    <!-- Decoración fondo -->
                    <i class="fas fa-map-marked-alt absolute -bottom-6 -right-6 text-9xl text-stone-100 opacity-50 rotate-12 pointer-events-none"></i>
                    
                    <h3 class="section-title relative z-10">
                        <span class="step-badge">3</span> Datos Geográficos
                    </h3>
                    
                    <div class="mb-6 p-3 bg-amber-50 border border-amber-100 rounded-lg flex items-start gap-3 relative z-10">
                        <div class="bg-amber-100 p-1.5 rounded-full text-amber-600"><i class="fas fa-magic"></i></div>
                        <div>
                            <p class="text-xs font-bold text-amber-900 uppercase mb-0.5">Autocompletado</p>
                            <p class="text-xs text-amber-700">Dibuja en el mapa y estos datos se llenarán solos.</p>
                        </div>
                    </div>

                    <div class="space-y-5 relative z-10">
                        <div class="grid grid-cols-2 gap-5">
                            <div>
                                <label class="label-field">Área (Ha)</label>
                                <input type="number" name="superficie" id="superficie" class="input-field font-bold text-amber-800 text-lg bg-white shadow-sm" step="0.01" readonly>
                            </div>
                            <div>
                                <label class="label-field">Altura (msnm)</label>
                                <input type="number" name="altura" id="altura" class="input-field font-bold text-stone-700 bg-white shadow-sm" readonly>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-5">
                            <div>
                                <label class="label-field">País</label>
                                <input type="text" name="pais" id="pais" class="input-field input-readonly" readonly>
                            </div>
                            <div>
                                <label class="label-field">Departamento</label>
                                <input type="text" name="departamento" id="departamento" class="input-field input-readonly" readonly>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-5">
                            <div>
                                <label class="label-field">Provincia</label>
                                <input type="text" name="provincia" id="provincia" class="input-field input-readonly" readonly>
                            </div>
                            <div>
                                <label class="label-field">Distrito</label>
                                <input type="text" name="distrito" id="distrito" class="input-field input-readonly" readonly>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN 4: FOTOS -->
                <div class="section-card mb-24">
                    <h3 class="section-title">
                        <span class="step-badge">4</span> Fotos del Predio
                    </h3>
                    <p class="text-sm text-stone-500 mb-4">Sube hasta 3 fotos representativas de tu finca para el pasaporte digital.</p>
                    
                    <div class="grid grid-cols-3 gap-3" id="photo-preview-grid">
                        <!-- Botón Subir -->
                        <label class="aspect-square bg-stone-50 rounded-xl border-2 border-dashed border-stone-300 flex flex-col items-center justify-center cursor-pointer hover:bg-stone-100 hover:border-amber-300 transition active:scale-95 group">
                            <div class="w-10 h-10 rounded-full bg-stone-200 flex items-center justify-center mb-2 group-hover:bg-amber-100 transition">
                                <i class="fas fa-plus text-stone-500 group-hover:text-amber-600"></i>
                            </div>
                            <span class="text-[10px] text-stone-500 font-bold uppercase group-hover:text-amber-700">Agregar</span>
                            <input type="file" id="photo-input" class="hidden" accept="image/*" multiple>
                        </label>
                    </div>
                </div>

                <!-- Barra de Acción Flotante -->
                <div class="fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur border-t border-stone-200 p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-40">
                    <div class="max-w-xl mx-auto">
                        <button type="submit" id="btn-save" class="w-full bg-amber-800 hover:bg-amber-900 text-white font-display font-bold py-4 rounded-xl shadow-lg text-lg flex items-center justify-center gap-3 transition transform active:scale-[0.98]">
                            <span>Guardar Ficha</span>
                            <i class="fas fa-check-circle"></i>
                        </button>
                    </div>
                </div>

            </form>

            <div id="success-message" class="hidden text-center py-32 animate-fade-in-up">
                <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm border-4 border-green-50">
                    <i class="fas fa-check text-5xl text-green-600"></i>
                </div>
                <h2 class="text-4xl font-display font-bold text-stone-900 mb-3">¡Excelente!</h2>
                <p class="text-stone-600 text-lg max-w-xs mx-auto leading-relaxed">La información de tu finca se ha actualizado correctamente en el sistema.</p>
                
                <div class="mt-10">
                    <a href="https://rurulab.com" class="text-amber-800 font-bold hover:underline text-sm uppercase tracking-wider">Ir a Ruru Lab</a>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- VARIABLES GLOBALES ---
        let map, drawingManager, currentPolygon, geocoder;
        let currentImages = [];
        const token = new URLSearchParams(window.location.search).get('t');

        // --- INICIALIZACIÓN ---
        window.initMap = function() {
            if (!token) {
                document.getElementById('loading').innerHTML = `
                    <div class="bg-red-50 border border-red-100 p-6 rounded-2xl inline-block">
                        <i class="fas fa-exclamation-circle text-4xl text-red-500 mb-3"></i>
                        <p class="text-red-800 font-bold">Enlace inválido o incompleto.</p>
                        <p class="text-red-600 text-sm mt-1">Por favor verifica la URL.</p>
                    </div>`;
                return;
            }
            loadData();
        };

        // --- CARGA DE DATOS ---
        async function loadData() {
            try {
                const res = await fetch(`/api/public/fincas/${token}`);
                if (!res.ok) throw new Error("Enlace expirado o no válido.");
                const data = await res.json();
                
                populateForm(data);
                initMapComponent(data.coordenadas);
                
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('public-form').classList.remove('hidden');
            } catch (e) {
                document.getElementById('loading').innerHTML = `
                    <div class="bg-red-50 border border-red-100 p-6 rounded-2xl inline-block">
                        <i class="fas fa-link text-4xl text-red-400 mb-3"></i>
                        <p class="text-red-800 font-bold text-lg">${e.message}</p>
                    </div>`;
            }
        }

        function populateForm(data) {
            const setVal = (id, val) => { if(document.getElementById(id)) document.getElementById(id).value = val || ''; };
            
            setVal('nombre_finca', data.nombre_finca);
            setVal('propietario', data.propietario);
            setVal('dni_ruc', data.dni_ruc);
            setVal('telefono', data.telefono);
            setVal('numero_trabajadores', data.numero_trabajadores);
            setVal('historia', data.historia);
            
            // Datos Geográficos
            setVal('superficie', data.superficie);
            setVal('altura', data.altura);
            setVal('pais', data.pais);
            setVal('departamento', data.departamento);
            setVal('provincia', data.provincia);
            setVal('distrito', data.distrito);

            // Foto Productor
            if (data.foto_productor) {
                document.getElementById('productor-foto-preview').src = data.foto_productor;
                document.getElementById('foto_productor').value = data.foto_productor;
            }

            // Fotos Predio
            if(data.imagenes_json && Array.isArray(data.imagenes_json)) {
                data.imagenes_json.forEach(img => addImagePreview(img));
            }
        }

        // --- MAPA Y GEOMETRÍA ---
        function initMapComponent(savedCoords) {
            const defaultLoc = { lat: -9.19, lng: -75.015 }; // Centro Perú
            
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 13,
                center: defaultLoc,
                mapTypeId: 'hybrid',
                streetViewControl: false,
                mapTypeControl: false,
                zoomControl: true,
                fullscreenControl: false
            });

            geocoder = new google.maps.Geocoder();

            // Dibujar si existe
            if (savedCoords && Array.isArray(savedCoords) && savedCoords.length > 0) {
                const paths = savedCoords.map(p => ({ lat: p[0], lng: p[1] }));
                drawPolygon(paths);
            }

            // Drawing Manager
            drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: savedCoords ? null : google.maps.drawing.OverlayType.POLYGON,
                drawingControl: true,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: ['polygon']
                },
                polygonOptions: {
                    fillColor: '#d97706', // Amber-600
                    fillOpacity: 0.4,
                    strokeColor: '#d97706',
                    strokeWeight: 2,
                    editable: true
                }
            });
            drawingManager.setMap(map);

            google.maps.event.addListener(drawingManager, 'overlaycomplete', function(event) {
                if (currentPolygon) currentPolygon.setMap(null);
                drawingManager.setDrawingMode(null);
                currentPolygon = event.overlay;
                updateCoords();
                autoPopulateFields(currentPolygon); // Lógica inteligente

                // Listeners de edición
                currentPolygon.getPath().addListener('set_at', () => { updateCoords(); autoPopulateFields(currentPolygon, true); });
                currentPolygon.getPath().addListener('insert_at', () => { updateCoords(); autoPopulateFields(currentPolygon, true); });
            });
        }

        function drawPolygon(paths) {
            if (currentPolygon) currentPolygon.setMap(null);
            currentPolygon = new google.maps.Polygon({
                paths: paths,
                fillColor: '#d97706',
                fillOpacity: 0.4,
                strokeColor: '#d97706',
                strokeWeight: 2,
                editable: true,
                map: map
            });
            
            const bounds = new google.maps.LatLngBounds();
            paths.forEach(p => bounds.extend(p));
            map.fitBounds(bounds);

            currentPolygon.getPath().addListener('set_at', () => { updateCoords(); autoPopulateFields(currentPolygon, true); });
            currentPolygon.getPath().addListener('insert_at', () => { updateCoords(); autoPopulateFields(currentPolygon, true); });
            updateCoords();
        }

        function updateCoords() {
            if (!currentPolygon) return;
            const path = currentPolygon.getPath();
            const coords = [];
            for (let i = 0; i < path.getLength(); i++) {
                const xy = path.getAt(i);
                coords.push([xy.lat(), xy.lng()]);
            }
            document.getElementById('coordenadas').value = JSON.stringify(coords);
        }

        // --- AUTOCOMPLETADO INTELIGENTE ---
        async function autoPopulateFields(polygon, onlyArea = false) {
            if (!polygon) return;

            // 1. Área
            if (google.maps.geometry && google.maps.geometry.spherical) {
                const areaM2 = google.maps.geometry.spherical.computeArea(polygon.getPath());
                const areaHa = (areaM2 / 10000).toFixed(2);
                document.getElementById('superficie').value = areaHa;
                highlightField('superficie');
            }

            if (onlyArea) return;

            // Centroide
            let latSum = 0, lngSum = 0;
            const path = polygon.getPath();
            const len = path.getLength();
            for (let i = 0; i < len; i++) { latSum += path.getAt(i).lat(); lngSum += path.getAt(i).lng(); }
            const center = { lat: latSum / len, lng: lngSum / len };

            // 2. Altura (Open-Meteo)
            try {
                const elevRes = await fetch(`https://api.open-meteo.com/v1/elevation?latitude=${center.lat}&longitude=${center.lng}`);
                const elevData = await elevRes.json();
                if (elevData.elevation && elevData.elevation.length > 0) {
                    document.getElementById('altura').value = Math.round(elevData.elevation[0]);
                    highlightField('altura');
                }
            } catch (e) { console.warn(e); }

            // 3. Ubicación (Google Geocoding)
            geocoder.geocode({ location: center }, (results, status) => {
                if (status === "OK" && results[0]) {
                    const components = results[0].address_components;
                    let pais='', depto='', prov='', dist='';
                    
                    for (const c of components) {
                        const t = c.types[0];
                        if (t === "country") pais = c.long_name;
                        if (t === "administrative_area_level_1") depto = c.long_name;
                        if (t === "administrative_area_level_2") prov = c.long_name;
                        if (t === "locality" || t === "administrative_area_level_3") dist = dist || c.long_name;
                    }

                    if(pais) { document.getElementById('pais').value = pais; highlightField('pais'); }
                    if(depto) { document.getElementById('departamento').value = depto; highlightField('departamento'); }
                    if(prov) { document.getElementById('provincia').value = prov; highlightField('provincia'); }
                    if(dist) { document.getElementById('distrito').value = dist; highlightField('distrito'); }
                }
            });
        }

        function highlightField(id) {
            const el = document.getElementById(id);
            // Animación suave de "flash" en ámbar
            el.classList.add('bg-amber-50', 'border-amber-300');
            setTimeout(() => el.classList.remove('bg-amber-50', 'border-amber-300'), 1500);
        }

        // --- BUSCADOR MAPA ---
        document.getElementById('btn-search-map').addEventListener('click', () => {
            const address = document.getElementById('map-search').value;
            if(!address) return;
            geocoder.geocode({ 'address': address }, function(results, status) {
                if (status === 'OK') {
                    map.setCenter(results[0].geometry.location);
                    map.setZoom(15);
                } else {
                    alert('No se encontró el lugar.');
                }
            });
        });

        // --- GEOLOCALIZACIÓN ---
        document.getElementById('btn-locate').addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    const latlng = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    map.setCenter(latlng);
                    map.setZoom(18);
                    new google.maps.Marker({ position: latlng, map: map, title: "Tú" });
                }, () => alert("Activa el GPS para usar esta función."));
            }
        });

        // --- FOTO PRODUCTOR ---
        document.getElementById('productor-foto-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) { alert("Máximo 5MB"); return; }
            
            const base64 = await compressImage(file);
            document.getElementById('productor-foto-preview').src = base64;
            document.getElementById('foto_productor').value = base64;
        });

        // --- FOTOS PREDIO ---
        document.getElementById('photo-input').addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            for (const file of files) {
                if (currentImages.length >= 3) break;
                if (file.size > 5 * 1024 * 1024) { alert("Foto muy pesada (Max 5MB)"); continue; }
                const base64 = await compressImage(file);
                addImagePreview(base64);
            }
            e.target.value = ''; // Reset input
        });

        function addImagePreview(base64) {
            currentImages.push(base64);
            const div = document.createElement('div');
            div.className = "relative aspect-square rounded-xl overflow-hidden border border-stone-200 shadow-sm animate-pulse"; // Animación temporal
            setTimeout(() => div.classList.remove('animate-pulse'), 500);
            
            div.innerHTML = `
                <img src="${base64}" class="w-full h-full object-cover">
                <button type="button" class="absolute top-1 right-1 bg-red-600 text-white w-7 h-7 rounded-full flex items-center justify-center shadow-md active:scale-90 transition" onclick="removeImage(this, '${base64}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            const grid = document.getElementById('photo-preview-grid');
            grid.insertBefore(div, grid.lastElementChild);
        }

        window.removeImage = function(btn, base64) {
            btn.parentElement.remove();
            currentImages = currentImages.filter(img => img !== base64);
        }

        // --- UTILIDAD: COMPRESIÓN ---
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 1024;
                        let width = img.width;
                        let height = img.height;
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        };

        // --- SUBMIT ---
        document.getElementById('public-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-save');
            const originalContent = btn.innerHTML;
            
            btn.disabled = true; 
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Guardando...`;
            btn.classList.add('opacity-75', 'cursor-not-allowed');

            try {
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                
                data.imagenes_json = currentImages;
                if (data.coordenadas) {
                    try { data.coordenadas = JSON.parse(data.coordenadas); } catch(e) { data.coordenadas = null; }
                }

                const res = await fetch(`/api/public/fincas/${token}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!res.ok) throw new Error("Error al guardar.");

                document.getElementById('public-form').classList.add('hidden');
                document.getElementById('success-message').classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });

            } catch (err) {
                alert("Error: " + err.message);
                btn.disabled = false; 
                btn.innerHTML = originalContent;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        });
    </script>
</body>
</html>