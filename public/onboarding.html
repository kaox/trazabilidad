<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bienvenido a Ruru Lab</title>
    <!-- Verificar autenticación al cargar -->
    <link href="/css/styles.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    
    <!-- Librería Intl-Tel-Input (Restaurada) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/css/intlTelInput.css">
    
    <script src="/js/analytics-loader.js" defer></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fdfaf6; }
        h1, h2, h3, .font-display { font-family: 'Playfair Display', serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Ajustes para intl-tel-input */
        .iti { width: 100%; }
        .iti__flag { background-image: url("https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/img/flags.png"); }
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
          .iti__flag { background-image: url("https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/img/flags@2x.png"); }
        }

        /* Input más amigable para dedos */
        #celular {
            height: 3.5rem; /* 56px de altura */
            font-size: 1.1rem;
        }
    </style>
</head>
<body class="text-stone-800 antialiased flex items-center justify-center min-h-screen py-12 px-4">
    
    <div class="w-full max-w-3xl bg-white rounded-3xl shadow-2xl overflow-hidden fade-in">
        <!-- Banner de Bienvenida (Solo visible si viene por Magic Link) -->
        <div id="welcome-banner" class="bg-gradient-to-r from-amber-700 to-amber-900 p-8 text-white text-center hidden">
            <div class="w-16 h-16 bg-white/20 backdrop-blur rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                ✨
            </div>
            <h1 class="text-3xl font-display font-bold mb-2">¡Hola! Tu perfil ya está casi listo</h1>
            <p class="text-amber-100 max-w-lg mx-auto">Reclama tu espacio en Ruru Lab. Confirma tus datos y crea tu contraseña para comenzar.</p>
        </div>

        <!-- Encabezado Estándar (Si no es Magic Link) -->
        <div id="standard-header" class="text-center pt-10 px-10 pb-0">
            <h1 class="text-3xl font-display font-bold text-amber-900">Configuración Inicial</h1>
            <p class="text-stone-500 mt-2">Completa tu perfil para comenzar a trazar.</p>
        </div>
        
        <div class="p-8 md:p-12">
            <form id="onboarding-form" class="space-y-8">
                <!-- 1. Identidad de la Empresa -->
                <section>
                    <h3 class="text-lg font-bold text-stone-700 border-b border-stone-100 pb-2 mb-4 flex items-center gap-2">
                        <i class="fas fa-building text-amber-600"></i> Tu Empresa / Finca
                    </h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-stone-700 mb-1">Tipo de Entidad</label>
                            <select id="company_type" name="company_type" class="w-full p-3 border border-stone-300 rounded-xl bg-white focus:ring-2 focus:ring-amber-500 outline-none h-[3.5rem]">
                                <option value="finca">Finca / Productor</option>
                                <option value="procesadora">Procesadora / Empresa</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-stone-700 mb-1">WhatsApp de Contacto *</label>
                            <!-- inputmode="tel" activa el teclado numérico en móviles -->
                            <input type="tel" id="celular" name="celular" class="w-full p-3 border border-stone-300 rounded-xl focus:ring-2 focus:ring-amber-500 outline-none" inputmode="tel" required>
                            <span id="msg-celular" class="text-xs mt-1 hidden font-bold"></span>
                        </div>
                    </div>
                    
                    <!-- Previsualización de Logo Precargado -->
                    <div class="flex items-center gap-6 mb-6 bg-stone-50 p-4 rounded-xl border border-stone-200">
                        <div class="relative group">
                            <img id="logo-preview" src="https://placehold.co/100?text=Logo" class="w-24 h-24 rounded-xl object-contain bg-white shadow-sm border border-stone-200">
                            <div class="absolute inset-0 bg-black/40 rounded-xl flex items-center justify-center opacity-0 group-hover:opacity-100 transition cursor-pointer" onclick="document.getElementById('company_logo_input').click()">
                                <i class="fas fa-camera text-white"></i>
                            </div>
                        </div>
                        <div class="flex-grow">
                            <!-- Campos para PROCESADORA / EMPRESA -->
                            <div id="field-commercial-name">
                                <label class="block text-xs font-bold text-stone-400 uppercase mb-1">Nombre Comercial</label>
                                <input type="text" id="empresa" name="empresa" class="w-full p-3 border border-stone-300 rounded-xl font-bold text-stone-800 text-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Nombre de tu Marca o Empresa">
                            </div>

                            <!-- Campos para FINCA / PRODUCTOR (Ocultos por defecto) -->
                            <div id="field-finca-details" class="hidden space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-stone-400 uppercase mb-1">Nombre de la Finca</label>
                                    <input type="text" id="nombre_finca" name="nombre_finca" class="w-full p-3 border border-stone-300 rounded-xl font-bold text-stone-800 text-lg focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Ej: Finca La Esperanza">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-stone-400 uppercase mb-1">Nombre del Propietario</label>
                                    <input type="text" id="nombre_propietario" name="nombre_propietario" class="w-full p-3 border border-stone-300 rounded-xl bg-white focus:ring-2 focus:ring-amber-500 outline-none" placeholder="Nombre completo del productor">
                                </div>
                            </div>
                            
                            <!-- Input oculto para el archivo -->
                            <input type="file" id="company_logo_input" class="hidden" accept="image/*">
                            <input type="hidden" id="company_logo_base64" name="company_logo">
                        </div>
                    </div>

                    <!-- Redes Sociales Precargadas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div class="relative">
                            <i class="fab fa-instagram absolute left-3 top-3.5 text-pink-600 text-lg"></i>
                            <input type="text" id="social_instagram" name="social_instagram" class="w-full pl-10 p-3 border border-stone-300 rounded-xl" placeholder="Usuario Instagram">
                        </div>
                        <div class="relative">
                            <i class="fab fa-facebook absolute left-3 top-3.5 text-blue-600 text-lg"></i>
                            <input type="text" id="social_facebook" name="social_facebook" class="w-full pl-10 p-3 border border-stone-300 rounded-xl" placeholder="Link Facebook">
                        </div>
                    </div>
                </section>

                <!-- 2. Seguridad (Solo si es Magic Link) -->
                <section id="security-section" class="hidden bg-amber-50 p-6 rounded-2xl border border-amber-200">
                    <h3 class="text-lg font-bold text-amber-900 mb-2 flex items-center gap-2">
                        <i class="fas fa-lock"></i> Crea tus Credenciales
                    </h3>
                    <p class="text-sm text-amber-800 mb-4">Como entraste con un enlace mágico, por favor define tus credenciales para ingresar la próxima vez.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-stone-700 mb-1">Usuario</label>
                            <input type="text" id="usuario" name="usuario" class="w-full p-3 border border-stone-300 rounded-xl bg-white" placeholder="usuario_ejemplo">
                            <p class="text-[10px] text-stone-500 mt-1">Solo letras, números, puntos y guiones bajos.</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-stone-700 mb-1">Nueva Contraseña</label>
                            <input type="password" id="password" name="password" class="w-full p-3 border border-stone-300 rounded-xl bg-white" placeholder="********" minlength="6">
                        </div>
                    </div>
                </section>

                <!-- Botón Final -->
                <button type="submit" id="submit-btn" class="w-full bg-stone-900 hover:bg-black text-white font-bold py-4 rounded-xl shadow-lg transition transform hover:-translate-y-1 text-lg flex items-center justify-center gap-2">
                    <span>Completar Registro</span> <i class="fas fa-arrow-right"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- Script de Intl-Tel-Input -->
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/intlTelInput.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const form = document.getElementById('onboarding-form');
            const welcomeBanner = document.getElementById('welcome-banner');
            const standardHeader = document.getElementById('standard-header');
            const securitySection = document.getElementById('security-section');
            const logoPreview = document.getElementById('logo-preview');
            const logoHidden = document.getElementById('company_logo_base64');
            const companyTypeSelect = document.getElementById('company_type');
            
            // Campos dinámicos
            const fieldCommercial = document.getElementById('field-commercial-name');
            const fieldFinca = document.getElementById('field-finca-details');
            const inputEmpresa = document.getElementById('empresa');
            const inputNombreFinca = document.getElementById('nombre_finca');
            const inputPropietario = document.getElementById('nombre_propietario');
            
            // Validación de Usuario
            const usuarioInput = document.getElementById('usuario');
            if (usuarioInput) {
                usuarioInput.addEventListener('input', function() {
                    this.value = this.value.toLowerCase().replace(/[^a-z0-9._]/g, '');
                });
            }

            // --- Configuración de Teléfono ---
            const msgPhone = document.querySelector("#msg-celular");
            const inputPhone = document.querySelector("#celular");
            const iti = window.intlTelInput(inputPhone, {
                utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.2.1/build/js/utils.js",
                initialCountry: "auto",
                geoIpLookup: function(callback) {
                    fetch("https://ipapi.co/json")
                    .then(res => res.json())
                    .then(data => callback(data.country_code))
                    .catch(() => callback("pe"));
                },
                separateDialCode: true,
                preferredCountries: ['pe', 'co', 'ec', 'mx', 'us'],
                autoPlaceholder: "aggressive", // Muestra máscara de ejemplo
                formatOnDisplay: true
            });

            // Función de Validación de Teléfono
            const validatePhone = () => {
                const isValid = iti.isValidNumber();
                const errorCode = iti.getValidationError();
                
                if (inputPhone.value.trim() === '') {
                    inputPhone.classList.remove("border-red-500", "border-green-500");
                    msgPhone.classList.add("hidden");
                    return false;
                }

                if (isValid) {
                    inputPhone.classList.remove("border-red-500");
                    inputPhone.classList.add("border-green-500");
                    msgPhone.classList.add("hidden");
                    return true;
                } else {
                    inputPhone.classList.add("border-red-500");
                    inputPhone.classList.remove("border-green-500");
                    
                    const errorMap = ["Número inválido", "Código de país inválido", "Demasiado corto", "Demasiado largo", "Número inválido"];
                    const msg = errorMap[errorCode] || "Número inválido";
                    msgPhone.textContent = msg;
                    msgPhone.classList.remove("hidden");
                    msgPhone.className = "text-xs mt-1 font-bold text-red-600 block";
                    return false;
                }
            };

            // Validar al salir del campo
            inputPhone.addEventListener('blur', validatePhone);
            // Limpiar error al escribir
            inputPhone.addEventListener('input', () => {
                inputPhone.classList.remove("border-red-500", "border-green-500");
                msgPhone.classList.add("hidden");
            });
            
            // --- Lógica de Tipo de Entidad ---
            function toggleFields() {
                if (companyTypeSelect.value === 'finca') {
                    fieldCommercial.classList.add('hidden');
                    fieldFinca.classList.remove('hidden');
                    inputNombreFinca.required = true;
                    inputPropietario.required = true;
                    inputEmpresa.required = false;
                } else {
                    fieldCommercial.classList.remove('hidden');
                    fieldFinca.classList.add('hidden');
                    inputNombreFinca.required = false;
                    inputPropietario.required = false;
                    inputEmpresa.required = true;
                }
            }

            companyTypeSelect.addEventListener('change', toggleFields);
            toggleFields();

            // --- DETECCIÓN DE MAGIC LINK ---
            const params = new URLSearchParams(window.location.search);
            const magicToken = params.get('magic_token');

            // Si no hay magic_token, verificar si hay sesión normal
            if (!magicToken) {
                // Lógica de Auth Check simple
                fetch('/api/user/profile').then(res => {
                    if(!res.ok) window.location.href = '/login.html';
                });
            } else {
                // --- MODO MAGIC LINK ---
                document.getElementById('welcome-banner').classList.remove('hidden');
                document.getElementById('standard-header').classList.add('hidden');
                document.getElementById('security-section').classList.remove('hidden');
                
                document.getElementById('usuario').required = true;
                document.getElementById('password').required = true;

                // Cargar datos precargados (SIN AUTH, usando el token)
                try {
                    const res = await fetch(`/api/public/magic-data/${magicToken}`);
                    if (!res.ok) throw new Error("Link expirado");
                    const data = await res.json();

                    // Llenar formulario
                    companyTypeSelect.value = data.company_type || 'finca';
                    toggleFields();
                    
                    if (data.empresa) {
                        document.getElementById('empresa').value = data.empresa;
                        document.getElementById('nombre_finca').value = data.empresa; // Default
                    }
                    if (data.social_instagram) document.getElementById('social_instagram').value = data.social_instagram;
                    if (data.social_facebook) document.getElementById('social_facebook').value = data.social_facebook;
                    
                    if (data.company_logo) {
                        document.getElementById('logo-preview').src = data.company_logo;
                        document.getElementById('company_logo_base64').value = data.company_logo;
                    }

                } catch (e) {
                    alert("El enlace mágico no es válido o ha expirado.");
                    window.location.href = '/';
                }
            }

            // Manejo de Logo (Preview)
            document.getElementById('company_logo_input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        document.getElementById('logo-preview').src = ev.target.result;
                        document.getElementById('company_logo_base64').value = ev.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Guardar
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('submit-btn');
                btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                // Preparar Payload
                let finalName = data.company_type === 'finca' ? data.nombre_finca : data.empresa;
                const payload = {
                    company_type: data.company_type,
                    empresa: finalName,
                    celular: iti.getNumber(),
                    company_logo: data.company_logo,
                    social_instagram: data.social_instagram,
                    social_facebook: data.social_facebook,
                    // Datos personales
                    nombre: data.company_type === 'finca' ? data.nombre_propietario : '',
                    apellido: ''
                };

                try {
                    if (magicToken) {
                        // --- FLUJO MAGIC LINK: REGISTRO NUEVO ---
                        payload.magic_token = magicToken;
                        payload.usuario = data.usuario;
                        payload.password = data.password;

                        const res = await fetch('/api/public/magic-register', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                            credentials: 'include'
                        });
                        
                        const result = await res.json();
                        if(!res.ok) throw new Error(result.error || 'Error en registro');
                        
                        window.location.href = result.redirect || '/app/dashboard';

                    } else {
                        // --- FLUJO NORMAL: ACTUALIZACIÓN PERFIL ---
                        // (Si el usuario ya estaba logueado y entró a onboarding)
                        const res = await fetch('/api/user/profile', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                            credentials: 'include'
                        });
                        if(!res.ok) throw new Error('Error al actualizar');
                        window.location.href = '/app/dashboard';
                    }

                } catch (err) {
                    alert(err.message);
                    btn.disabled = false; btn.innerText = "Intentar de nuevo";
                }
            });
        });
    </script>
</body>
</html>