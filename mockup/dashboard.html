<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Analítico - Trazabilidad de Chocolate</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fdfaf6;
        }
        h1, h2, h3, .font-display {
            font-family: 'Playfair Display', serif;
        }
    </style>
</head>
<body class="text-stone-800 antialiased">

    <nav class="bg-amber-900 text-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex justify-center items-center h-16">
                <a href="fincas.html" class="px-4 py-2 rounded-md text-sm font-medium hover:bg-amber-800 transition">Fincas</a>
                <a href="bean-to-bar-tracker.html" class="px-4 py-2 rounded-md text-sm font-medium hover:bg-amber-800 transition">Trazabilidad</a>
                <a href="dashboard.html" class="px-4 py-2 rounded-md text-sm font-medium bg-amber-800 transition">Dashboard</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 md:p-8">

        <header class="text-center mb-10 mt-4">
            <h1 class="text-4xl md:text-5xl font-bold text-amber-900 mb-2">Dashboard Analítico</h1>
            <p class="text-stone-600">Visualiza los datos clave de tu proceso "bean to bar".</p>
        </header>

        <!-- Sección de Inventario en Tiempo Real -->
        <section id="inventory-section" class="mb-12">
            <h2 class="text-2xl font-display text-amber-900 border-b pb-2 mb-6">Inventario en Proceso</h2>
            <div id="inventory-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Las tarjetas de inventario se generarán aquí -->
            </div>
        </section>

        <!-- Sección de Gráficos -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h3 class="text-xl font-display text-amber-900 mb-4 text-center">Rendimiento Promedio por Etapa</h3>
                <canvas id="rendimientoChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h3 class="text-xl font-display text-amber-900 mb-4 text-center">Producción por Finca (kg Cacao en Baba)</h3>
                <canvas id="produccionChart"></canvas>
            </div>
        </section>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const inventoryCardsContainer = document.getElementById('inventory-cards');

        // --- Cargar Datos ---
        let allBatches = {};
        let allFincas = [];
        try {
            const storedBatches = localStorage.getItem('chocolateTrackerBatches');
            allBatches = storedBatches ? JSON.parse(storedBatches) : {};
            const storedFincas = localStorage.getItem('chocolateTrackerFincas');
            allFincas = storedFincas ? JSON.parse(storedFincas) : [];
        } catch (e) {
            console.error("Error al cargar los datos:", e);
        }

        // --- Procesamiento de Datos ---
        const processMetrics = {
            fermentacion: { input: 'pesoBaba', output: 'pesoFermentadoHumedo', totalInput: 0, totalOutput: 0, count: 0 },
            secado: { input: 'pesoFermentadoHumedo', output: 'pesoSeco', totalInput: 0, totalOutput: 0, count: 0 },
            tostado: { input: 'pesoSeco', output: 'pesoTostado', totalInput: 0, totalOutput: 0, count: 0 },
            molienda: { input: 'pesoTostado', output: 'pesoProductoFinal', totalInput: 0, totalOutput: 0, count: 0 }
        };

        const produccionPorFinca = {};
        const inventario = {
            'Cosechado (listo para fermentar)': { total: 0, unit: 'kg Baba'},
            'Fermentado (listo para secar)': { total: 0, unit: 'kg Húmedo'},
            'Seco (listo para tostar)': { total: 0, unit: 'kg Seco'},
            'Tostado (listo para moler)': { total: 0, unit: 'kg Tostado'}
        };

        Object.values(allBatches).forEach(cosecha => {
            // Producción por Finca
            const fincaName = cosecha.finca || 'Finca no especificada';
            if (!produccionPorFinca[fincaName]) {
                produccionPorFinca[fincaName] = 0;
            }
            produccionPorFinca[fincaName] += parseFloat(cosecha.pesoBaba) || 0;
            
            // Inventario Cosechado y Rendimiento de Fermentación
            let babaAsignada = 0;
            (cosecha.fermentaciones || []).forEach(fermentacion => {
                babaAsignada += parseFloat(fermentacion.pesoBaba) || 0;
                processMetrics.fermentacion.totalInput += parseFloat(fermentacion.pesoBaba) || 0;
                processMetrics.fermentacion.totalOutput += parseFloat(fermentacion.pesoFermentadoHumedo) || 0;
                processMetrics.fermentacion.count++;

                // Inventario Fermentado y Rendimiento de Secado
                let fermentadoAsignado = 0;
                (fermentacion.secados || []).forEach(secado => {
                    fermentadoAsignado += parseFloat(secado.pesoFermentadoHumedo) || 0;
                    processMetrics.secado.totalInput += parseFloat(secado.pesoFermentadoHumedo) || 0;
                    processMetrics.secado.totalOutput += parseFloat(secado.pesoSeco) || 0;
                    processMetrics.secado.count++;

                    // Inventario Seco y Rendimiento de Tostado
                    let secoAsignado = 0;
                    (secado.tostados || []).forEach(tostado => {
                        secoAsignado += parseFloat(tostado.pesoSeco) || 0;
                        processMetrics.tostado.totalInput += parseFloat(tostado.pesoSeco) || 0;
                        processMetrics.tostado.totalOutput += parseFloat(tostado.pesoTostado) || 0;
                        processMetrics.tostado.count++;
                        
                        // Inventario Tostado y Rendimiento de Molienda
                        let tostadoAsignado = 0;
                        (tostado.moliendas || []).forEach(molienda => {
                           tostadoAsignado += parseFloat(molienda.pesoTostado) || 0;
                           processMetrics.molienda.totalInput += parseFloat(molienda.pesoTostado) || 0;
                           processMetrics.molienda.totalOutput += parseFloat(molienda.pesoProductoFinal) || 0;
                           processMetrics.molienda.count++;
                        });
                        inventario['Tostado (listo para moler)'].total += (parseFloat(tostado.pesoTostado) || 0) - tostadoAsignado;
                    });
                    inventario['Seco (listo para tostar)'].total += (parseFloat(secado.pesoSeco) || 0) - secoAsignado;
                });
                inventario['Fermentado (listo para secar)'].total += (parseFloat(fermentacion.pesoFermentadoHumedo) || 0) - fermentadoAsignado;
            });
            inventario['Cosechado (listo para fermentar)'].total += (parseFloat(cosecha.pesoBaba) || 0) - babaAsignada;
        });

        // --- Renderizar Inventario ---
        Object.keys(inventario).forEach(key => {
            const card = document.createElement('div');
            card.className = 'bg-white p-5 rounded-2xl shadow-lg text-center';
            card.innerHTML = `
                <p class="text-stone-500 text-sm">${key}</p>
                <p class="text-3xl font-bold text-amber-900 mt-2">${inventario[key].total.toFixed(2)}</p>
                <p class="text-stone-500 text-xs">${inventario[key].unit}</p>
            `;
            inventoryCardsContainer.appendChild(card);
        });

        // --- Renderizar Gráfico de Rendimiento ---
        const rendimientoData = Object.values(processMetrics).map(metric => {
            return metric.totalInput > 0 ? (metric.totalOutput / metric.totalInput) * 100 : 0;
        });
        const rendimientoLabels = ['Fermentación', 'Secado', 'Tostado', 'Molienda'];

        new Chart(document.getElementById('rendimientoChart'), {
            type: 'bar',
            data: {
                labels: rendimientoLabels,
                datasets: [{
                    label: 'Rendimiento (%)',
                    data: rendimientoData,
                    backgroundColor: 'rgba(120, 53, 15, 0.6)',
                    borderColor: 'rgba(120, 53, 15, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: { y: { beginAtZero: true, max: 100, ticks: { callback: value => value + '%' } } },
                plugins: { legend: { display: false } }
            }
        });

        // --- Renderizar Gráfico de Producción por Finca ---
        new Chart(document.getElementById('produccionChart'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(produccionPorFinca),
                datasets: [{
                    label: 'Producción',
                    data: Object.values(produccionPorFinca),
                    backgroundColor: [
                        'rgba(120, 53, 15, 0.7)',
                        'rgba(180, 83, 9, 0.7)',
                        'rgba(217, 119, 6, 0.7)',
                        'rgba(245, 158, 11, 0.7)',
                        'rgba(251, 191, 36, 0.7)'
                    ],
                    hoverOffset: 4
                }]
            }
        });

    });
    </script>
</body>
</html>
