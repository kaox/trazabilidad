<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trazabilidad de Chocolate: Bean to Bar</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- qrcode-generator -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fdfaf6;
        }
        h1, h2, h3, .font-display {
            font-family: 'Playfair Display', serif;
        }
        dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
        .rotate-90 {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="text-stone-800 antialiased">

    <nav class="bg-amber-900 text-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex justify-center items-center h-16">
                <a href="fincas.html" class="px-4 py-2 rounded-md text-sm font-medium hover:bg-amber-800 transition">Fincas</a>
                <a href="bean-to-bar-tracker.html" class="px-4 py-2 rounded-md text-sm font-medium bg-amber-800 transition">Trazabilidad</a>
            </div>
        </div>
    </nav>

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-6xl">

        <header class="text-center mb-8 mt-4">
            <h1 class="text-4xl md:text-5xl font-bold text-amber-900 mb-2">Trazabilidad "Bean to Bar"</h1>
            <p class="text-stone-600">Gestión jerárquica de lotes, desde la cosecha hasta la molienda.</p>
        </header>

        <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
            <div class="flex justify-center">
                <button id="crearCosechaBtn" class="bg-amber-800 hover:bg-amber-900 text-white font-bold py-3 px-6 rounded-xl shadow-md hover:shadow-lg transition transform hover:-translate-y-0.5">
                    + Iniciar Nueva Cosecha
                </button>
            </div>
        </div>

        <!-- Contenedor Principal de la App -->
        <main id="dashboard-view">
            <!-- Las cosechas y sus sub-lotes se renderizarán aquí -->
        </main>
        
        <div id="welcome-screen" class="text-center bg-white p-8 rounded-2xl shadow-lg hidden">
             <img src="https://placehold.co/150x150/854d0e/ffffff?text=🍫" alt="Icono de Chocolate" class="mx-auto mb-4 rounded-full">
            <h2 class="text-3xl font-display text-amber-900 mb-2">Bienvenido</h2>
            <p class="text-stone-600">Inicia una nueva cosecha para comenzar a registrar el proceso de tu chocolate.</p>
        </div>
    </div>

    <!-- Modal para Formularios -->
    <dialog id="form-modal" class="p-0 rounded-2xl shadow-2xl w-full max-w-xl">
        <div id="modal-content" class="p-6">
            <!-- El contenido del formulario se inyectará aquí -->
        </div>
    </dialog>
    
    <div id="qr-code-container" style="display: none;"></div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE MANAGEMENT ---
        let state = {
            batches: {}, // Ahora los `batches` son las cosechas
        };

        // --- DOM ELEMENTS ---
        const crearCosechaBtn = document.getElementById('crearCosechaBtn');
        const dashboardView = document.getElementById('dashboard-view');
        const welcomeScreen = document.getElementById('welcome-screen');
        const formModal = document.getElementById('form-modal');
        const modalContent = document.getElementById('modal-content');

        // --- CONFIGURACIÓN DE PROCESOS ---
        const processHierarchy = ['cosecha', 'fermentacion', 'secado', 'tostado', 'molienda'];
        const processConfig = {
            cosecha: { plural: 'fermentaciones', singular: 'fermentacion', outputWeightField: 'pesoBaba', icon: `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM6.5 8.5a.5.5 0 01.5-.5h2a.5.5 0 01.5.5v2a.5.5 0 01-1 0V9h-1.5a.5.5 0 01-.5-.5zM10 5a.5.5 0 01.5.5v2a.5.5 0 01-1 0V5.5A.5.5 0 0110 5zm3.5 3.5a.5.5 0 01.5-.5h2a.5.5 0 01.5.5v2a.5.5 0 01-1 0V9h-1.5a.5.5 0 01-.5-.5z" clip-rule="evenodd" /></svg>`},
            fermentacion: { plural: 'secados', singular: 'secado', outputWeightField: 'pesoFermentadoHumedo', icon: `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 20 20" fill="currentColor"><path d="M5 3a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2H5zm0 2h10v10H5V5z" /><path d="M7 7h2v2H7V7zm4 0h2v2h-2V7z" /></svg>`},
            secado: { plural: 'tostados', singular: 'tostado', outputWeightField: 'pesoSeco', icon: `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-1.636 4.95l.707-.707a1 1 0 10-1.414-1.414l-.707.707a1 1 0 101.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1zM6.343 7.657a1 1 0 010-1.414l.707-.707a1 1 0 011.414 1.414l-.707.707a1 1 0 01-1.414 0zm-.707 7.071a1 1 0 011.414 0l.707.707a1 1 0 01-1.414 1.414l-.707-.707a1 1 0 010-1.414zM10 17a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1z" clip-rule="evenodd" /></svg>`},
            tostado: { plural: 'moliendas', singular: 'molienda', outputWeightField: 'pesoTostado', icon: `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 01-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>`},
            molienda: { plural: null, singular: null, outputWeightField: 'pesoProductoFinal', icon: `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z" /></svg>`}
        };

        // --- INICIALIZACIÓN ---
        function init() {
            loadState();
            renderDashboard();
            crearCosechaBtn.addEventListener('click', () => openFormModal('create', 'cosecha'));
            formModal.addEventListener('click', (e) => {
                if (e.target.id === 'form-modal') formModal.close();
            });
        }

        // --- LOCAL STORAGE ---
        function saveState() {
            try {
                localStorage.setItem('chocolateTrackerBatches', JSON.stringify(state.batches));
            } catch (e) {
                console.error("Error guardando en localStorage:", e);
            }
        }

        function loadState() {
            try {
                const storedBatches = localStorage.getItem('chocolateTrackerBatches');
                state.batches = storedBatches ? JSON.parse(storedBatches) : {};
            } catch (e) {
                console.error("Error cargando desde localStorage:", e);
                state.batches = {};
            }
        }

        // --- LÓGICA DE DATOS ---
        function generateId(prefix = 'LOTE') {
            const now = new Date();
            const timestamp = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
            const random = Math.random().toString(36).substring(2, 6);
            return `${prefix}-${timestamp}-${random}`;
        }

        function getBatchByPath(path) {
            if (!path) return null;
            const ids = path.split('>');
            let currentCollection = state.batches;
            let finalBatch = null;

            for (let i = 0; i < ids.length; i++) {
                const id = ids[i];
                const [type, key] = id.split(':');

                if (i === 0) { // Harvest level (object)
                    if (type !== 'cosecha' || !currentCollection.hasOwnProperty(key)) return null;
                    finalBatch = currentCollection[key];
                    const config = processConfig[type];
                    if (config.plural) {
                        currentCollection = finalBatch[config.plural];
                    }
                } else { // Sub-batch level (array)
                    if (!Array.isArray(currentCollection)) return null;
                    finalBatch = currentCollection.find(b => b.id === key);
                    if (!finalBatch) return null;
                    
                    const config = processConfig[type];
                    if (config.plural) {
                        currentCollection = finalBatch[config.plural];
                    }
                }
            }
            return finalBatch;
        }

        function getParentBatch(path) {
            if (!path || !path.includes('>')) return null;
            const parentPath = path.split('>').slice(0, -1).join('>');
            return getBatchByPath(parentPath);
        }

        function deleteBatchByPath(path) {
            const parent = getParentBatch(path);
            const ids = path.split('>');
            const [type, key] = ids[ids.length - 1].split(':');

            if (!parent) { // Deleting a harvest
                if (state.batches[key]) {
                    delete state.batches[key];
                    return true;
                }
                return false;
            }

            const parentType = ids[ids.length-2].split(':')[0];
            const childrenArray = parent[processConfig[parentType].plural];

            const indexToDelete = childrenArray.findIndex(b => b.id === key);
            if (indexToDelete > -1) {
                childrenArray.splice(indexToDelete, 1);
                return true;
            }
            return false;
        }


        function calculateAvailableWeight(parentBatch, parentType) {
            const config = processConfig[parentType];
            if (!config || !config.plural) return 0;

            const totalOutputWeight = parseFloat(parentBatch[config.outputWeightField]) || 0;
            
            const childrenArray = parentBatch[config.plural];
            if (!Array.isArray(childrenArray)) {
                return totalOutputWeight;
            }

            const assignedWeight = childrenArray.reduce((sum, child) => {
                const inputWeightField = config.outputWeightField; 
                return sum + (parseFloat(child[inputWeightField]) || 0);
            }, 0);
            
            return totalOutputWeight - assignedWeight;
        }

        // --- RENDERIZADO DE UI ---
        function renderDashboard() {
            dashboardView.innerHTML = '';
            const harvestIds = Object.keys(state.batches);
            if (harvestIds.length === 0) {
                welcomeScreen.classList.remove('hidden');
                return;
            }
            welcomeScreen.classList.add('hidden');

            harvestIds.sort().reverse().forEach(id => {
                const harvestBatch = state.batches[id];
                dashboardView.appendChild(createBatchCard(harvestBatch, 'cosecha', `cosecha:${id}`));
            });
        }
        
        function createBatchCard(batch, type, path) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-md mb-4 overflow-hidden';
            
            const config = processConfig[type];
            const hasChildren = config.plural && batch[config.plural] && batch[config.plural].length > 0;
            const availableWeight = calculateAvailableWeight(batch, type);

            const cardHeader = document.createElement('div');
            cardHeader.className = `p-4 border-l-4 border-amber-800 flex justify-between items-start ${hasChildren ? 'cursor-pointer hover:bg-stone-50 transition-colors' : ''}`;

            let infoHtml = '';
            const parentBatch = getParentBatch(path);
            const parentType = parentBatch ? path.split('>').slice(-2, -1)[0].split(':')[0] : null;

            if (type === 'cosecha') {
                infoHtml = `
                    <p class="text-sm text-stone-500">Finca: <strong>${batch.finca || 'N/A'}</strong></p>
                    <p class="text-sm text-stone-500 mt-1">Fecha: ${batch.fechaCosecha || 'N/A'}</p>
                `;
            } else {
                 const inputField = processConfig[parentType].outputWeightField;
                 infoHtml = `<p class="text-sm text-stone-600"><span class="font-semibold">Entrada:</span> ${batch[inputField] || 0} kg</p>`;
            }
            
            if (type === 'tostado' && batch.perfilAroma) {
                const truncatedAroma = batch.perfilAroma.length > 40 ? batch.perfilAroma.substring(0, 40) + '...' : batch.perfilAroma;
                infoHtml += `<p class="text-sm text-stone-500 mt-1" title="${batch.perfilAroma}">Aroma: <strong>${truncatedAroma}</strong></p>`;
            }
            
            if (type === 'molienda') {
                 infoHtml += `<p class="text-sm text-stone-500 mt-1">Producto: <strong>${batch.productoFinal || 'N/A'}</strong></p>`;
            }


            cardHeader.innerHTML = `
                <div class="flex items-center gap-3">
                     ${batch.imageUrl ? `<img src="${batch.imageUrl}" class="w-16 h-16 rounded-md object-cover flex-shrink-0" alt="Foto del lote">` : `<div class="w-16 h-16 flex items-center justify-center text-amber-800 flex-shrink-0">${config.icon}</div>`}
                     ${hasChildren ? `
                        <svg class="w-5 h-5 text-stone-400 transition-transform duration-300 expand-icon flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                     ` : '<div class="w-5"></div>' }
                    <div>
                        <h3 class="font-bold text-lg text-amber-900">${type.charAt(0).toUpperCase() + type.slice(1)}: ${batch.id}</h3>
                        ${infoHtml}
                        <div class="mt-2 text-sm">
                            <span class="font-semibold">Peso Salida:</span> ${batch[config.outputWeightField] || 0} kg
                            ${config.plural ? `<span class="ml-4 font-semibold text-green-700">Disponible:</span> ${availableWeight.toFixed(2)} kg` : ''}
                        </div>
                    </div>
                </div>
                <div class="flex gap-2 flex-shrink-0 ml-4 items-start">
                    ${type === 'molienda' ? `<button class="qr-btn text-sm bg-sky-600 hover:bg-sky-700 text-white font-bold px-3 py-1 rounded-lg" data-id="${batch.id}">QR</button>` : ''}
                    <button class="edit-btn text-sm bg-stone-200 hover:bg-stone-300 px-3 py-1 rounded-lg" data-path="${path}" data-type="${type}">Editar</button>
                    <button class="delete-btn text-sm bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg" data-path="${path}" data-type="${type}">X</button>
                    ${config.plural ? `<button ${availableWeight <= 0 ? 'disabled' : ''} class="add-sub-btn text-sm bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-lg disabled:bg-gray-400 disabled:cursor-not-allowed" data-path="${path}" data-type="${type}">+ Añadir</button>` : ''}
                </div>
            `;
            
            const childrenContainer = document.createElement('div');
            childrenContainer.className = 'ml-6 mt-0 pl-4 border-l-2 border-stone-200 hidden'; 

            if (hasChildren) {
                batch[config.plural].forEach(childBatch => {
                    const childPath = `${path}>${config.singular}:${childBatch.id}`;
                    childrenContainer.appendChild(createBatchCard(childBatch, config.singular, childPath));
                });
            }

            card.appendChild(cardHeader);
            card.appendChild(childrenContainer);
            
            if (hasChildren) {
                cardHeader.addEventListener('click', (e) => {
                    if (e.target.closest('button')) {
                        return;
                    }
                    childrenContainer.classList.toggle('hidden');
                    const icon = cardHeader.querySelector('.expand-icon');
                    if (icon) {
                        icon.classList.toggle('rotate-90');
                    }
                });
            }

            return card;
        }

        // --- LÓGICA DE FORMULARIOS Y MODAL ---
        function openFormModal(mode, type, path = null) {
            const isCreating = mode === 'create';
            let parentBatch = null;

            if (isCreating) {
                parentBatch = path ? getBatchByPath(path) : null;
            } else {
                parentBatch = getParentBatch(path);
            }

            if (isCreating && path && !parentBatch) {
                console.error("No se pudo encontrar el lote padre en la ruta:", path);
                alert("Error: No se encontró el lote padre para crear un sub-lote.");
                return;
            }

            let batchData = !isCreating ? getBatchByPath(path) : {};

            if (!isCreating && !batchData) {
                console.error("No se pudo encontrar el lote para editar en la ruta:", path);
                return;
            }
            if (!batchData) batchData = {};

            const parentType = parentBatch ? path.split('>').pop().split(':')[0] : null;

            const availableWeight = parentBatch ? calculateAvailableWeight(parentBatch, parentType) : 0;
            
            modalContent.innerHTML = generateFormHTML(mode, type, batchData, parentBatch, availableWeight);
            formModal.showModal();

            // Adjuntar listener para el input de imagen
            const imageInput = modalContent.querySelector('.image-upload-input');
            if(imageInput) {
                imageInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if(file) {
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            const preview = document.getElementById('image-preview');
                            const hiddenInput = document.getElementById('image-hidden-input');
                            if(preview) preview.src = reader.result;
                            if(hiddenInput) hiddenInput.value = reader.result;
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            const form = document.getElementById('batch-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const newData = {};
                for (let [key, value] of formData.entries()) {
                    newData[key] = value;
                }
                
                // Validación de peso mejorada
                if (parentBatch && processConfig[parentType]) {
                    const inputWeightField = processConfig[parentType].outputWeightField;
                    if (inputWeightField) {
                        let weightLimit = availableWeight;
                        if (mode === 'edit') {
                            weightLimit += parseFloat(batchData[inputWeightField]) || 0;
                        }
                        if (parseFloat(newData[inputWeightField]) > weightLimit) {
                             alert(`El peso de entrada (${newData[inputWeightField]} kg) no puede exceder el límite de ${weightLimit.toFixed(2)} kg.`);
                             return;
                        }
                    }
                }
                
                if (mode === 'create') {
                    newData.id = generateId(type.toUpperCase().substring(0, 3));
                    const childTypeConfig = processConfig[type];
                    if (childTypeConfig.plural) {
                        newData[childTypeConfig.plural] = [];
                    }

                    if (parentBatch) {
                        parentBatch[processConfig[parentType].plural].push(newData);
                    } else { // Creando una cosecha
                        state.batches[newData.id] = newData;
                    }
                } else { // Edit
                    Object.assign(batchData, newData);
                }

                saveState();
                renderDashboard();
                formModal.close();
            });

            document.getElementById('cancel-btn').addEventListener('click', () => formModal.close());
        }

        function createFincaSelectHTML(selectedValue = '') {
            let fincas = [];
            try {
                const storedFincas = localStorage.getItem('chocolateTrackerFincas');
                fincas = storedFincas ? JSON.parse(storedFincas) : [];
            } catch (e) {
                console.error("Error loading fincas for select:", e);
            }
            
            if (fincas.length === 0) {
                return `<div>
                    <label class="block text-sm font-medium text-stone-700 mb-1">Finca</label>
                    <div class="p-3 border border-stone-300 rounded-xl bg-stone-50 text-stone-500">
                        No hay fincas registradas. Por favor, <a href="fincas.html" class="text-sky-600 hover:underline">registra una finca</a> primero.
                    </div>
                    <input type="hidden" name="finca" value="">
                </div>`;
            }

            const optionsHTML = fincas.map(finca => 
                `<option value="${finca.nombreFinca}" ${finca.nombreFinca === selectedValue ? 'selected' : ''}>
                    ${finca.nombreFinca} (${finca.propietario})
                </option>`
            ).join('');

            return `<div>
                <label for="finca" class="block text-sm font-medium text-stone-700 mb-1">Asociar Finca</label>
                <select id="finca" name="finca" class="w-full p-3 border border-stone-300 rounded-xl shadow-sm focus:ring-2 focus:ring-amber-800 transition" required>
                    <option value="">Seleccionar una finca...</option>
                    ${optionsHTML}
                </select>
            </div>`;
        }

        function generateFormHTML(mode, type, data = {}, parentBatch = null, availableWeight = 0) {
            let formFields = '';
            
            if (parentBatch) {
                 const parentType = (Object.keys(processConfig).find(key => processConfig[key].plural === type+'es' || processConfig[key].plural === type+'s')) || 'cosecha';
                 const inputWeightField = processConfig[parentType].outputWeightField;
                 let currentInputWeight = data[inputWeightField] || '';
                 let limit = availableWeight;
                 if(mode === 'edit') {
                    limit += parseFloat(currentInputWeight) || 0;
                 }
                 formFields += createInput(inputWeightField, `Peso Entrada (kg)`, 'number', `Disponible: ${limit.toFixed(2)} kg`, currentInputWeight);
            }
            
            const hasImageUpload = ['cosecha', 'fermentacion', 'secado', 'tostado'].includes(type);

            switch(type) {
                case 'cosecha':
                    formFields += createFincaSelectHTML(data.finca);
                    formFields += createInput('id', 'ID Cosecha', 'text', 'Se generará automáticamente', data.id, true);
                    formFields += createInput('fechaCosecha', 'Fecha de Cosecha', 'date', '', data.fechaCosecha);
                    formFields += createInput('pesoMazorcas', 'Peso Mazorcas (kg)', 'number', '', data.pesoMazorcas);
                    formFields += createInput('pesoBaba', 'Peso Cacao en Baba (kg)', 'number', 'Peso de salida', data.pesoBaba);
                    break;
                case 'fermentacion':
                    formFields += createInput('fechaInicio', 'Fecha Inicio Fermentación', 'date', '', data.fechaInicio);
                    formFields += createSelect('metodo', 'Método de Fermentación', ['bandejas Rohan', 'cajones de madera', 'otro'], data.metodo);
                    formFields += createInput('duracion', 'Duración (días)', 'number', '', data.duracion);
                    formFields += createInput('pesoFermentadoHumedo', 'Peso Fermentado Húmedo (kg)', 'number', 'Peso de salida', data.pesoFermentadoHumedo);
                    break;
                case 'secado':
                    formFields += createInput('fechaInicio', 'Fecha Inicio Secado', 'date', '', data.fechaInicio);
                    formFields += createSelect('metodo', 'Método de Secado', ['túneles de secado', 'marquesinas', 'hornos', 'guardiolas', 'otro'], data.metodo);
                    formFields += createInput('duracion', 'Duración (días)', 'number', '', data.duracion);
                    formFields += createInput('pesoSeco', 'Peso Cacao Seco (kg)', 'number', 'Peso de salida', data.pesoSeco);
                    break;
                case 'tostado':
                    formFields += createInput('fechaTostado', 'Fecha de Tostado', 'date', '', data.fechaTostado);
                    formFields += createSelect('clasificacion', 'Tamaño del Grano', ['Grandes', 'Medianos', 'Pequeños', 'Mezcla'], data.clasificacion);
                    formFields += createSelect('metodo', 'Método de Tostado', ['Conducción', 'Convección', 'Híbrido', 'Radiación', 'Otro'], data.metodo);
                    formFields += createInput('tempMinima', 'Temp. Mínima (°C)', 'number', '', data.tempMinima);
                    formFields += createInput('tempMaxima', 'Temp. Máxima (°C)', 'number', '', data.tempMaxima);
                    formFields += createInput('duracion', 'Duración (min)', 'number', '', data.duracion);
                    formFields += createTextArea('perfilAroma', 'Perfil de Aroma', 'Ej: notas a caramelo, frutos secos, floral...', data.perfilAroma);
                    formFields += createInput('pesoTostado', 'Peso Cacao Tostado (kg)', 'number', 'Peso de salida', data.pesoTostado);
                    break;
                case 'molienda':
                    formFields += createInput('fecha', 'Fecha de Procesamiento', 'date', '', data.fecha);
                    formFields += createInput('pesoNibs', 'Peso Nibs Obtenidos (kg)', 'number', '', data.pesoNibs);
                    formFields += createSelect('productoFinal', 'Producto Final', ['Pasta de cacao (licor)', 'Manteca de cacao', 'Cacao en polvo', 'Otro'], data.productoFinal);
                    formFields += createInput('pesoProductoFinal', 'Peso Producto Final (kg)', 'number', 'Peso de salida final', data.pesoProductoFinal);
                    break;
            }

            if (hasImageUpload) {
                formFields += createImageInputHTML('imageUrl', `Foto de ${type}`, data.imageUrl);
            }

            return `
                <form id="batch-form">
                    <h2 class="text-2xl font-display text-amber-900 border-b pb-2 mb-4">${mode === 'create' ? 'Crear' : 'Editar'} Lote de ${type}</h2>
                    <div class="space-y-4 max-h-[60vh] overflow-y-auto p-1">
                        ${formFields}
                    </div>
                    <div class="flex justify-end gap-4 mt-6">
                        <button type="button" id="cancel-btn" class="bg-stone-300 hover:bg-stone-400 text-stone-800 font-bold py-2 px-6 rounded-xl">Cancelar</button>
                        <button type="submit" class="bg-amber-800 hover:bg-amber-900 text-white font-bold py-2 px-6 rounded-xl">${mode === 'create' ? 'Guardar' : 'Actualizar'}</button>
                    </div>
                </form>
            `;
        }
        
        function createImageInputHTML(id, label, value = '') {
            return `<div class="pt-4 border-t">
                <label class="block text-sm font-medium text-stone-700 mb-1">${label}</label>
                <div class="mt-1 flex items-center gap-4">
                    <img id="image-preview" src="${value || 'https://placehold.co/100x100/e7e5e4/a8a29e?text=Foto'}" alt="Previsualización" class="h-24 w-24 rounded-lg object-cover">
                    <div>
                        <input type="file" class="image-upload-input block w-full text-sm text-stone-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-amber-50 file:text-amber-700 hover:file:bg-amber-100" accept="image/*">
                        <input type="hidden" id="image-hidden-input" name="${id}" value="${value || ''}">
                        <p class="text-xs text-stone-500 mt-2">Sube una imagen para este proceso (JPG, PNG).</p>
                    </div>
                </div>
            </div>`;
        }

        function createInput(id, label, type, placeholder = '', value = '', readonly = false) {
             return `<div>
                <label for="${id}" class="block text-sm font-medium text-stone-700 mb-1">${label}</label>
                <input type="${type}" id="${id}" name="${id}" value="${value || ''}" placeholder="${placeholder}" 
                       class="w-full p-3 border border-stone-300 rounded-xl shadow-sm focus:ring-2 focus:ring-amber-800 transition ${readonly ? 'bg-stone-100' : ''}" 
                       ${readonly ? 'readonly' : ''} ${type === 'number' ? 'step="0.01"' : ''} required>
            </div>`;
        }

        function createSelect(id, label, options, selectedValue = '') {
            const optionsHTML = options.map(opt => `<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${opt}</option>`).join('');
            return `<div>
                <label for="${id}" class="block text-sm font-medium text-stone-700 mb-1">${label}</label>
                <select id="${id}" name="${id}" class="w-full p-3 border border-stone-300 rounded-xl shadow-sm focus:ring-2 focus:ring-amber-800 transition" required>
                    <option value="">Seleccionar...</option>
                    ${optionsHTML}
                </select>
            </div>`;
        }
        
        function createTextArea(id, label, placeholder = '', value = '') {
            return `<div>
                <label for="${id}" class="block text-sm font-medium text-stone-700 mb-1">${label}</label>
                <textarea id="${id}" name="${id}" placeholder="${placeholder}" rows="3"
                          class="w-full p-3 border border-stone-300 rounded-xl shadow-sm focus:ring-2 focus:ring-amber-800 transition">${value || ''}</textarea>
            </div>`;
        }
        
        function generateAndDownloadQR(id) {
            const url = `https://qr.burgoschocolate.com/${id}`;
            const qr = qrcode(0, 'L');
            qr.addData(url);
            qr.make();
            
            const qrContainer = document.getElementById('qr-code-container');
            qrContainer.innerHTML = qr.createDataURL(10, 5);
            
            const downloadLink = document.createElement('a');
            downloadLink.href = qrContainer.firstChild.src;
            downloadLink.download = `QR_${id}.png`;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

        // --- MANEJADORES DE EVENTOS ---
        dashboardView.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            
            const { path, type } = target.dataset;

            if (target.classList.contains('add-sub-btn')) {
                const childType = processConfig[type].singular;
                openFormModal('create', childType, path);
            } else if (target.classList.contains('edit-btn')) {
                openFormModal('edit', type, path);
            } else if (target.classList.contains('delete-btn')) {
                if (confirm('¿Estás seguro de que deseas eliminar este lote y todos sus sub-lotes?')) {
                    if (deleteBatchByPath(path)) {
                        saveState();
                        renderDashboard();
                    } else {
                        alert('Error: No se pudo eliminar el lote.');
                    }
                }
            } else if (target.classList.contains('qr-btn')) {
                 generateAndDownloadQR(target.dataset.id);
            }
        });

        // --- INICIAR LA APP ---
        init();
    });
    </script>

</body>
</html>

